<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }
    .invoice-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #fff;
    }
    .product-list {
      list-style-type: none;
      padding-left: 0;
    }
    .product-list li {
      background: #eef;
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">üìú ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
    <div id="customersContainer"></div>
  </div>

  <!-- Firebase Compat SDK (v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (Firebase Console ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶§‡¶•‡ßç‡¶Ø)
    const firebaseConfig = {
      apiKey: "AIzaSyAlCr-cphqHaAGN8SoDJ_aOnVBzJOyFLyo",
      authDomain: "post-41a7c.firebaseapp.com",
      projectId: "post-41a7c",
      storageBucket: "post-41a7c.firebasestorage.app",
      messagingSenderId: "266157241851",
      appId: "1:266157241851:web:a36fe15cc1a46b01aac75e",
      measurementId: "G-GQ1BKHFPMP"
    };

    // Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶è‡¶¨‡¶Ç Firestore ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá (‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
    const productDetails = {};

    // ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá "products" ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ "invoices" ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶æ
    function loadData() {
      // ‡ßß) "products" ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡ßã‡¶°
      db.collection("products").get()
        .then(productSnapshot => {
          productSnapshot.forEach(prodDoc => {
            productDetails[prodDoc.id] = prodDoc.data();
          });
          // ‡ß®) ‡¶è‡¶∞‡¶™‡¶∞ "invoices" ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶≤‡ßã‡¶°
          return db.collection("invoices").get();
        })
        .then(invoiceSnapshot => {
          const customers = {};

          invoiceSnapshot.forEach(doc => {
            const data = doc.data();

            // ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞
            const memoNumber = data.memoNo || "‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡ßá‡¶á";

            // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (timestamp ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá)
            let invoiceDate = "‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡ßá‡¶á";
            if (data.timestamp && data.timestamp.toDate) {
              const dateObj = data.timestamp.toDate();
              invoiceDate = dateObj.toLocaleDateString("bn-BD", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric"
              });
            }

            // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞
            const customerName = data.customerName || "‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";
            const customerMobile = data.customerMobile || "‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡ßá‡¶á";

            // ‡¶Ø‡¶¶‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶ø
            if (!customers[customerMobile]) {
              customers[customerMobile] = {
                name: customerName,
                mobile: customerMobile,
                invoices: [],
                customerTotal: 0  // ‡¶è‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ finalTotal ‡¶Ø‡ßã‡¶ó‡¶´‡¶≤
              };
            }

            // ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ (items ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá)
            const items = data.items || [];

            // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßã‡¶ü ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨: ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ (‡¶¶‡¶æ‡¶Æ * ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£) ‡¶Ø‡ßã‡¶ó‡¶´‡¶≤
            let invoiceTotal = 0;
            items.forEach(item => {
              const product = productDetails[item.productId] || {};
              const price = product.price || 0;
              const qty = item.quantity || 0;
              invoiceTotal += price * qty;
            });

            // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá, ‡¶®‡¶á‡¶≤‡ßá 0
            const discount = data.discount || 0;
            // ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ (‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡ßü‡ßá)
            const finalTotal = invoiceTotal - discount;

            // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶∞‡ßü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡ßá ‡¶è‡¶á ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
            customers[customerMobile].customerTotal += finalTotal;

            // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶è‡¶á ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            customers[customerMobile].invoices.push({
              memoNumber,
              date: invoiceDate,
              items,
              invoiceTotal,
              discount,
              finalTotal
            });
          });

          // ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§, HTML ‡¶è ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø
          renderCustomers(customers);
        })
        .catch(error => {
          console.error("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", error);
          document.getElementById("customersContainer").innerHTML = `<p class="text-danger">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</p>`;
        });
    }

    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ì ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ HTML ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function renderCustomers(customers) {
      const container = document.getElementById("customersContainer");
      let html = "";

      Object.values(customers).forEach((customer, index) => {
        const customerId = `customer${index}`;

        html += `
          <div class="card invoice-card">
            <div class="card-header">
              <h5 class="mb-0">${customer.name}</h5>
              <p class="mb-1"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> ${customer.mobile}</p>
              <p class="mb-1"><strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º:</strong> ${customer.customerTotal} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
              <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${customerId}">
                ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
              </button>
            </div>
            <div id="${customerId}" class="collapse">
              <div class="card-body">
                ${customer.invoices.map(invoice => `
                  <div class="card mb-2">
                    <div class="card-header">
                      <strong>‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç:</strong> ${invoice.memoNumber}
                    </div>
                    <div class="card-body">
                      <p><strong>‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${invoice.date}</p>
                      <h6>‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶∏‡¶Æ‡ßÇ‡¶π:</h6>
                      <ul class="product-list">
                        ${invoice.items.map(item => {
                          const product = productDetails[item.productId] || {};
                          const productName = product.name || "‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";
                          const productPrice = product.price || 0;
                          const quantity = item.quantity || 0;
                          const totalPrice = productPrice * quantity;
                          return `
                            <li>
                              <strong>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü:</strong> ${productName} |
                              <strong>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</strong> ${quantity} |
                              <strong>‡¶è‡¶ï‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</strong> ${productPrice} ‡¶ü‡¶æ‡¶ï‡¶æ |
                              <strong>‡¶Æ‡ßã‡¶ü:</strong> ${totalPrice} ‡¶ü‡¶æ‡¶ï‡¶æ
                            </li>
                          `;
                        }).join('')}
                      </ul>
                      <p><strong>‡¶Æ‡ßã‡¶ü:</strong> ${invoice.invoiceTotal} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                      <p><strong>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</strong> ${invoice.discount} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                      <p><strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</strong> ${invoice.finalTotal} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
    document.addEventListener("DOMContentLoaded", loadData);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
