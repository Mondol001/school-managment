<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }
    /* Header Bar */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .back-btn {
      font-size: 16px;
    }
    .empty-space {
      flex: 1;
    }
    .search-icon {
      font-size: 24px;
      cursor: pointer;
    }
    /* Title */
    .title {
      text-align: center;
      margin-bottom: 15px;
      font-size: 24px;
      font-weight: bold;
    }
    /* Search Container with Animation */
    .search-container {
      text-align: center;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.5s ease;
      margin-bottom: 15px;
    }
    .search-container.active {
      max-height: 60px;
      opacity: 1;
    }
    .search-box {
      width: 100%;
      max-width: 400px;
      height: 40px;
      padding: 5px 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 16px;
    }
    /* Invoice Card */
    .invoice-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
      padding: 15px;
      background-color: #fff;
    }
    .product-list {
      list-style-type: none;
      padding-left: 0;
    }
    .product-list li {
      background: #eef;
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Bar: Back Button (‡¶¨‡¶æ‡¶Æ), Empty (‡¶Æ‡¶æ‡¶ù‡ßá), Search Icon (‡¶°‡¶æ‡¶®) -->
    <div class="header-bar">
      <button class="btn btn-secondary back-btn" onclick="history.back()">‚¨ÖÔ∏è Back</button>
      <div class="empty-space"></div>
      <span class="search-icon" onclick="toggleSearch()">üîç</span>
    </div>

    <!-- Title -->
    <div class="title">üìú ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>

    <!-- Search Box (‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶®‡¶∏‡¶π, ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá) -->
    <div class="search-container" id="searchContainer">
      <input type="text" id="searchInput" class="search-box" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤..." onkeyup="searchCustomers()">
    </div>

    <!-- Customers Container -->
    <div id="customersContainer"></div>
  </div>

  <!-- Firebase Compat SDK (v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (Firebase Console ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶§‡¶•‡ßç‡¶Ø)
    const firebaseConfig = {
      apiKey: "AIzaSyAlCr-cphqHaAGN8SoDJ_aOnVBzJOyFLyo",
      authDomain: "post-41a7c.firebaseapp.com",
      projectId: "post-41a7c",
      storageBucket: "post-41a7c.firebasestorage.app",
      messagingSenderId: "266157241851",
      appId: "1:266157241851:web:a36fe15cc1a46b01aac75e",
      measurementId: "G-GQ1BKHFPMP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let customersData = {}; // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ì ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
    const productDetails = {}; // Products ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø

    // Firestore ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°: ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá products, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ invoices
    async function loadData() {
      try {
        // ‡ßß) Products ‡¶≤‡ßã‡¶°
        const productsSnapshot = await db.collection("products").get();
        productsSnapshot.forEach(prodDoc => {
          productDetails[prodDoc.id] = prodDoc.data();
        });
        // ‡ß®) Invoices ‡¶≤‡ßã‡¶°
        const invoicesSnapshot = await db.collection("invoices").get();
        const customers = {};
        invoicesSnapshot.forEach(doc => {
          const data = doc.data();
          const customerName = data.customerName || "‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";
          const customerMobile = data.customerMobile || "‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡ßá‡¶á";
          if (!customers[customerMobile]) {
            customers[customerMobile] = {
              name: customerName,
              mobile: customerMobile,
              invoices: [],
              customerTotal: 0
            };
          }
          // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: timestamp ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá (toDate() ‡¶Æ‡ßá‡¶•‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá)
          let invoiceDate = "‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡ßá‡¶á";
          if (data.timestamp && data.timestamp.toDate) {
            invoiceDate = data.timestamp.toDate().toLocaleDateString("bn-BD", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric"
            });
          }
          // ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ
          const items = data.items || [];
          let invoiceTotal = 0;
          items.forEach(item => {
            const prod = productDetails[item.productId] || {};
            const price = prod.price || 0;
            const qty = item.quantity || 0;
            invoiceTotal += price * qty;
          });
          // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü
          const discount = data.discount || 0;
          let finalTotal = data.finalTotal;
          if (finalTotal == null) {
            finalTotal = invoiceTotal - discount;
          }
          customers[customerMobile].invoices.push({
            memoNumber: data.memoNo || "‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡ßá‡¶á",
            date: invoiceDate,
            items: items,
            invoiceTotal: invoiceTotal,
            discount: discount,
            finalTotal: finalTotal
          });
          customers[customerMobile].customerTotal += finalTotal;
        });
        customersData = customers;
        renderCustomers(customers);
      } catch (error) {
        console.error("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", error);
        document.getElementById("customersContainer").innerHTML = `<p class="text-danger">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</p>`;
      }
    }

    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ì ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function renderCustomers(customers) {
      const container = document.getElementById("customersContainer");
      let html = "";
      Object.values(customers).forEach((customer, index) => {
        const customerId = `customer${index}`;
        let invoiceDetails = "";
        customer.invoices.forEach(invoice => {
          let itemsHtml = "";
          if (invoice.items.length > 0) {
            itemsHtml = `<h6>‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶∏‡¶Æ‡ßÇ‡¶π:</h6>
              <ul class="product-list">
                ${invoice.items.map(item => {
                  const prod = productDetails[item.productId] || {};
                  const prodName = prod.name || "‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";
                  const prodPrice = prod.price || 0;
                  const qty = item.quantity || 0;
                  const totalPrice = prodPrice * qty;
                  return `<li>
                            <strong>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü:</strong> ${prodName} |
                            <strong>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</strong> ${qty} |
                            <strong>‡¶è‡¶ï‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</strong> ${prodPrice} ‡¶ü‡¶æ‡¶ï‡¶æ |
                            <strong>‡¶Æ‡ßã‡¶ü:</strong> ${totalPrice} ‡¶ü‡¶æ‡¶ï‡¶æ
                          </li>`;
                }).join('')}
              </ul>`;
          }
          invoiceDetails += `
            <div class="card mb-2">
              <div class="card-header"><strong>‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç:</strong> ${invoice.memoNumber}</div>
              <div class="card-body">
                <p><strong>‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${invoice.date}</p>
                ${itemsHtml}
                <p><strong>‡¶Æ‡ßã‡¶ü:</strong> ${invoice.invoiceTotal} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                <p><strong>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</strong> ${invoice.discount} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                <p><strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</strong> ${invoice.finalTotal} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
              </div>
            </div>
          `;
        });
        html += `
          <div class="card invoice-card">
            <div class="card-header">
              <h5 class="mb-0">${customer.name}</h5>
              <p><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> ${customer.mobile}</p>
              <p><strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º:</strong> ${customer.customerTotal} ‡¶ü‡¶æ‡¶ï‡¶æ</p>
              <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${customerId}">
                ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
              </button>
            </div>
            <div id="${customerId}" class="collapse">
              <div class="card-body">
                ${invoiceDetails}
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ü‡¶ó‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function toggleSearch() {
      const searchContainer = document.getElementById("searchContainer");
      const searchInput = document.getElementById("searchInput");
      if (searchContainer.classList.contains("active")) {
        searchContainer.classList.remove("active");
        searchInput.value = "";
        renderCustomers(customersData);
      } else {
        searchContainer.classList.add("active");
        setTimeout(() => {
          searchInput.focus();
        }, 300);
      }
    }

    // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
    function searchCustomers() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const filtered = {};
      Object.keys(customersData).forEach(key => {
        const customer = customersData[key];
        if (customer.name.toLowerCase().includes(query) || customer.mobile.includes(query)) {
          filtered[key] = customer;
        }
      });
      renderCustomers(filtered);
    }

    document.addEventListener("DOMContentLoaded", loadData);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
