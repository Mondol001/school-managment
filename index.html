<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mondol Shop - Complete Firebase Integration</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Basic Styling */
    body {
      background-color: #f8f9fa;
    }
    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    .dark-mode .card {
      background-color: #1e1e1e;
    }
    /* Action Buttons & Filter */
    .action-buttons .btn {
      margin-right: 10px;
    }
    .filter-section {
      background: #fff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    /* Table Styling */
    .product-table {
      font-size: 0.95rem;
    }
    .product-table thead th {
      background-color: #e9ecef;
      text-align: center;
    }
    .product-table tbody td {
      vertical-align: middle;
      text-align: center;
    }
    /* Out of Stock Button Style */
    .btn-out-of-stock {
      pointer-events: none;
      cursor: not-allowed;
    }
    /* Suggestion List for Stock Update Modal */
    #updateStockSuggestion {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    /* Toast Container at Top Center */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1100;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-dark bg-primary shadow">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fas fa-store"></i> Mondol Shop</a>
      <div class="theme-toggle" id="themeToggle" style="cursor:pointer;">
        <i class="fas fa-moon text-white"></i>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <!-- Action Buttons -->
    <div class="action-buttons mb-4">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fas fa-plus-circle"></i> অ্যাড প্রোডাক্ট
      </button>
      <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#updateStockModal">
        <i class="fas fa-edit"></i> স্টক আপডেট
      </button>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#invoiceModal">
        <i class="fas fa-file-invoice"></i> ইনভয়েস তৈরি
      </button>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="text" id="searchInput" class="form-control" placeholder="পণ্যের নাম দিয়ে খুঁজুন">
        </div>
        <div class="col-md-6">
          <select id="stockFilter" class="form-select">
            <option value="all">সব পণ্য</option>
            <option value="inStock">স্টক আছে</option>
            <option value="outOfStock">স্টক নেই</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Product Table -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table product-table table-bordered table-striped table-hover">
            <thead>
              <tr>
                <th>পণ্যের নাম</th>
                <th>দাম</th>
                <th>স্টক</th>
                <th>ইউনিট</th>
                <th>অ্যাকশন</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- Firebase থেকে ডায়নামিক ডেটা লোড হবে -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header" id="toastHeader">
        <strong class="me-auto" id="toastTitle">Info</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <!-- Modals -->

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="addProductModalLabel"><i class="fas fa-plus"></i> নতুন প্রোডাক্ট যোগ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="বন্ধ"></button>
        </div>
        <div class="modal-body">
          <form id="addProductForm">
            <div class="mb-3">
              <label for="prodName" class="form-label">প্রোডাক্টের নাম</label>
              <input type="text" class="form-control" id="prodName" placeholder="প্রোডাক্টের নাম" required>
            </div>
            <div class="mb-3">
              <label for="prodUnit" class="form-label">ইউনিট টাইপ</label>
              <select class="form-select" id="prodUnit" required>
                <option value="kg">KG</option>
                <option value="liter">Liter</option>
                <option value="pcs">পিস</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="prodPrice" class="form-label">দাম</label>
              <div class="input-group">
                <span class="input-group-text">৳</span>
                <input type="number" class="form-control" id="prodPrice" placeholder="দাম" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="prodStock" class="form-label">স্টক কন্টিটি</label>
              <input type="number" class="form-control" id="prodStock" placeholder="স্টক সংখ্যা" required>
            </div>
            <button type="submit" class="btn btn-success w-100">প্রোডাক্ট যোগ করুন</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Stock Modal with Search -->
  <div class="modal fade" id="updateStockModal" tabindex="-1" aria-labelledby="updateStockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="updateStockModalLabel"><i class="fas fa-edit"></i> স্টক আপডেট করুন</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="বন্ধ"></button>
        </div>
        <div class="modal-body">
          <form id="updateStockForm">
            <!-- Search Field for Product -->
            <div class="mb-3 position-relative">
              <label for="updateStockSearch" class="form-label">পণ্য খুঁজুন</label>
              <input type="text" class="form-control" id="updateStockSearch" placeholder="পণ্যের নাম দিয়ে খুঁজুন">
              <div id="updateStockSuggestion" class="list-group"></div>
            </div>
            <!-- Hidden field for selected product ID -->
            <input type="hidden" id="updateProdId">
            <div class="mb-3">
              <label for="selectedProdName" class="form-label">প্রোডাক্টের নাম</label>
              <input type="text" class="form-control" id="selectedProdName" placeholder="নির্বাচিত পণ্য" disabled>
            </div>
            <div class="mb-3">
              <label for="selectedProdStock" class="form-label">বর্তমান স্টক</label>
              <input type="number" class="form-control" id="selectedProdStock" placeholder="বর্তমান স্টক" disabled>
            </div>
            <div class="mb-3">
              <label for="newProdStock" class="form-label">নতুন স্টক সংখ্যা</label>
              <input type="number" class="form-control" id="newProdStock" placeholder="নতুন স্টক সংখ্যা" required>
            </div>
            <button type="submit" class="btn btn-warning w-100">আপডেট করুন</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="invoiceModalLabel">
            <i class="fas fa-file-invoice"></i> ইনভয়েস (মেমো নং: <span id="memoNoDisplay"></span>)
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="বন্ধ"></button>
        </div>
        <div class="modal-body">
          <div id="invoiceContent">
            <!-- ইনভয়েসের বিস্তারিত এখানে দেখানো হবে -->
          </div>
        </div>
        <div class="modal-footer">
          <!-- Sales Button: বাম পাশে -->
          <button id="salesButton" class="btn btn-secondary">সেলস</button>
          <button id="printInvoice" class="btn btn-primary">প্রিন্ট করুন</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বন্ধ করুন</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    /***********************
     Firebase Configuration
    ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAlCr-cphqHaAGN8SoDJ_aOnVBzJOyFLyo",
      authDomain: "post-41a7c.firebaseapp.com",
      projectId: "post-41a7c",
      storageBucket: "post-41a7c.appspot.com",
      messagingSenderId: "266157241851",
      appId: "1:266157241851:web:a36fe15cc1a46b01aac75e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /***********************
     Toast Message Function (with type)
    ***********************/
    function showToast(message, type = 'info') {
      const toastHeader = document.getElementById('toastHeader');
      const toastTitle = document.getElementById('toastTitle');
      // Set default classes and title
      let headerClass = 'bg-primary';
      let titleText = 'Info';
      if (type === 'success') {
        headerClass = 'bg-success';
        titleText = 'সফল';
      } else if (type === 'error') {
        headerClass = 'bg-danger';
        titleText = 'ত্রুটি';
      } else if (type === 'warning') {
        headerClass = 'bg-warning';
        titleText = 'সতর্কতা';
      }
      // Update the header class and title text
      toastHeader.className = 'toast-header ' + headerClass + ' text-white';
      toastTitle.textContent = titleText;
      // Set message
      document.getElementById('toastBody').textContent = message;
      // Show toast
      const toastEl = document.getElementById('liveToast');
      const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
      toast.show();
    }

    /***********************
     Theme Toggle
    ***********************/
    document.getElementById('themeToggle').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      const icon = this.querySelector('i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    });

    /***********************
     Add Product Functionality
    ***********************/
    document.getElementById('addProductForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('prodName').value;
      const unit = document.getElementById('prodUnit').value;
      const price = parseFloat(document.getElementById('prodPrice').value);
      const stock = parseInt(document.getElementById('prodStock').value);
      db.collection('products').add({
        name,
        unitType: unit,
        price,
        stock,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        showToast('প্রোডাক্ট সফলভাবে যোগ হয়েছে!', 'success');
        document.getElementById('addProductForm').reset();
        const addModal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
        addModal.hide();
      })
      .catch(error => {
        console.error('Error adding product:', error);
        showToast('প্রোডাক্ট যোগ করতে সমস্যা হয়েছে!', 'error');
      });
    });

    /***********************
     Fetch and Display Products (Realtime)
    ***********************/
    let allProducts = [];
    function fetchProducts() {
      db.collection('products').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        applyFilters();
      });
    }
    fetchProducts();

    function renderProducts(products) {
      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = products.map(product => `
        <tr class="${product.stock <= 0 ? 'out-of-stock' : ''}">
          <td>${product.name}</td>
          <td>৳${product.price}</td>
          <td>${product.stock}</td>
          <td>${product.unitType}</td>
          <td>
            ${
              product.stock <= 0
              ? `<button class="btn btn-sm btn-danger btn-out-of-stock" disabled>আউট অফ স্টক</button>`
              : `<button class="btn btn-sm btn-success" onclick="addToInvoice('${product.id}', '${product.name}', '${product.unitType}', ${product.price})">
                   <i class="fas fa-cart-plus"></i> কার্টে যোগ করুন
                 </button>`
            }
          </td>
        </tr>
      `).join('');
    }

    /***********************
     Apply Filters
    ***********************/
    function applyFilters() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const stockFilter = document.getElementById('stockFilter').value;
      const filteredProducts = allProducts.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchInput);
        let matchesStock = true;
        if (stockFilter === 'inStock') {
          matchesStock = product.stock > 0;
        } else if (stockFilter === 'outOfStock') {
          matchesStock = product.stock <= 0;
        }
        return matchesSearch && matchesStock;
      });
      renderProducts(filteredProducts);
    }
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('stockFilter').addEventListener('change', applyFilters);

    /***********************
     Add to Invoice Cart Functionality
    ***********************/
    let invoiceCart = [];
    let memoNo = 1;
    function addToInvoice(id, name, unitType, price) {
      const existing = invoiceCart.find(item => item.id === id);
      if (existing) {
        existing.quantity += 1;
      } else {
        invoiceCart.push({ id, name, unitType, price, quantity: 1 });
      }
      showToast(`${name} কার্টে যোগ হয়েছে!`, 'success');
    }

    /***********************
     Get Available Stock for a Product
    ***********************/
    function getStockForProduct(id) {
      const prod = allProducts.find(p => p.id === id);
      return prod ? prod.stock : 0;
    }

    /***********************
     Invoice Modal Functionality with Quantity Validation and Unit Conversion for kg
    ***********************/
    document.getElementById('invoiceModal').addEventListener('show.bs.modal', function(event) {
      if (invoiceCart.length === 0) {
        showToast("কার্টে কোনো পণ্য নেই।", 'warning');
        event.preventDefault();
        return;
      }
      let invoiceHTML = `<h5>মেমো নং: INV-${memoNo}</h5>
                         <table class="table table-bordered mt-3">
                           <thead>
                             <tr>
                               <th>পণ্য</th>
                               <th>দাম</th>
                               <th>পরিমাণ</th>
                               <th>টোটাল</th>
                             </tr>
                           </thead>
                           <tbody>`;
      let totalAmount = 0;
      invoiceCart.forEach(item => {
        let qtyHtml = "";
        if(item.unitType === 'kg'){
          // যদি ইউনিট kg হয়, তাহলে কেজি ও গ্রামে ভাগ করে দেখাবে
          const kgPart = Math.floor(item.quantity);
          const gramPart = Math.round((item.quantity - kgPart) * 1000);
          qtyHtml = `<div class="input-group">
                        <input type="number" value="${kgPart}" min="0" class="form-control invoice-qty-kg" style="width:60px;">
                        <span class="input-group-text">কেজি</span>
                        <input type="number" value="${gramPart}" min="0" max="999" class="form-control invoice-qty-g" style="width:60px;">
                        <span class="input-group-text">গ্রাম</span>
                     </div>`;
          totalAmount += item.price * item.quantity;
        } else {
          qtyHtml = `<input type="number" value="${item.quantity}" min="1" class="form-control invoice-qty" style="width:80px;">`;
          totalAmount += item.price * item.quantity;
        }
        invoiceHTML += `<tr data-id="${item.id}" data-unit="${item.unitType}">
                          <td>${item.name}</td>
                          <td>৳${item.price}</td>
                          <td>${qtyHtml}</td>
                          <td class="item-total">৳${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>`;
      });
      invoiceHTML += `</tbody></table>
                      <h5 class="text-end">সর্বমোট: <span id="overallTotal">৳${totalAmount.toFixed(2)}</span></h5>`;
      document.getElementById('invoiceContent').innerHTML = invoiceHTML;
      document.getElementById('memoNoDisplay').textContent = memoNo;
      memoNo++;

      // Non-kg products: Validate quantity against available stock
      document.querySelectorAll('tr:not([data-unit="kg"]) .invoice-qty').forEach(input => {
        input.addEventListener('change', function() {
          const newQty = parseFloat(this.value);
          const tr = this.closest('tr');
          const prodId = tr.getAttribute('data-id');
          const availableStock = getStockForProduct(prodId);
          if(newQty > availableStock) {
            showToast("স্টকের চেয়ে বেশি পরিমাণ নিতে পারবেন না! সর্বোচ্চ: " + availableStock, 'warning');
            this.value = availableStock;
          }
          const qty = parseFloat(this.value);
          const price = parseFloat(tr.children[1].textContent.replace('৳',''));
          const newTotal = price * qty;
          tr.querySelector('.item-total').textContent = '৳' + newTotal.toFixed(2);
          let overall = 0;
          document.querySelectorAll('.item-total').forEach(td => {
            overall += parseFloat(td.textContent.replace('৳',''));
          });
          document.getElementById('overallTotal').textContent = '৳' + overall.toFixed(2);
        });
      });

      // kg products: Validate both kg and gram inputs
      document.querySelectorAll('tr[data-unit="kg"]').forEach(tr => {
        const kgInput = tr.querySelector('.invoice-qty-kg');
        const gInput = tr.querySelector('.invoice-qty-g');
        const price = parseFloat(tr.children[1].textContent.replace('৳',''));
        const prodId = tr.getAttribute('data-id');
        function updateKgRow() {
          let kg = parseFloat(kgInput.value) || 0;
          let grams = parseFloat(gInput.value) || 0;
          if(grams > 999){
            showToast("গ্রামে সর্বোচ্চ 999 গ্রাম হতে পারে!", 'warning');
            grams = 999;
            gInput.value = 999;
          }
          let totalQty = kg + (grams / 1000);
          const availableStock = getStockForProduct(prodId);
          if(totalQty > availableStock) {
            showToast("স্টকের চেয়ে বেশি পরিমাণ নিতে পারবেন না! সর্বোচ্চ: " + availableStock, 'warning');
            kg = Math.floor(availableStock);
            grams = Math.round((availableStock - kg) * 1000);
            kgInput.value = kg;
            gInput.value = grams;
            totalQty = availableStock;
          }
          const newTotal = price * totalQty;
          tr.querySelector('.item-total').textContent = '৳' + newTotal.toFixed(2);
          let overall = 0;
          document.querySelectorAll('.item-total').forEach(td => {
            overall += parseFloat(td.textContent.replace('৳',''));
          });
          document.getElementById('overallTotal').textContent = '৳' + overall.toFixed(2);
        }
        kgInput.addEventListener('change', updateKgRow);
        gInput.addEventListener('change', updateKgRow);
      });

      // Clear the invoice cart after generating the modal content
      invoiceCart = [];
    });

    /***********************
     Sales Button Functionality
    ***********************/
    document.getElementById('salesButton').addEventListener('click', function() {
      const rows = document.querySelectorAll('#invoiceContent tr[data-id]');
      rows.forEach(tr => {
        const prodId = tr.getAttribute('data-id');
        let qty = 0;
        if(tr.getAttribute('data-unit') === 'kg'){
          const kg = parseFloat(tr.querySelector('.invoice-qty-kg').value) || 0;
          const grams = parseFloat(tr.querySelector('.invoice-qty-g').value) || 0;
          qty = kg + (grams / 1000);
        } else {
          qty = parseFloat(tr.querySelector('.invoice-qty').value);
        }
        db.collection('products').doc(prodId).get().then(doc => {
          if (doc.exists) {
            const currentStock = doc.data().stock;
            let newStock = currentStock - qty;
            if (newStock < 0) newStock = 0;
            db.collection('products').doc(prodId).update({ stock: newStock });
          }
        });
      });
      showToast("সেলস সফল হয়েছে এবং স্টক আপডেট হয়েছে!", 'success');
    });

    /***********************
     Print Invoice Functionality
    ***********************/
    document.getElementById('printInvoice').addEventListener('click', function() {
      window.print();
    });

    /***********************
     Update Stock Modal with Search
    ***********************/
    // Listen for input on the search field inside Update Stock Modal
    document.getElementById('updateStockSearch').addEventListener('input', function() {
      const query = this.value.trim();
      const suggestionBox = document.getElementById('updateStockSuggestion');
      if(query.length === 0) {
        suggestionBox.style.display = 'none';
        suggestionBox.innerHTML = '';
        return;
      }
      db.collection('products')
        .orderBy('name')
        .startAt(query)
        .endAt(query + '\uf8ff')
        .get()
        .then(snapshot => {
          let suggestionsHTML = '';
          snapshot.forEach(doc => {
            const product = doc.data();
            suggestionsHTML += `<button type="button" class="list-group-item list-group-item-action" 
              data-id="${doc.id}" data-name="${product.name}" data-stock="${product.stock}">
                ${product.name} (স্টক: ${product.stock})
              </button>`;
          });
          if(suggestionsHTML) {
            suggestionBox.innerHTML = suggestionsHTML;
            suggestionBox.style.display = 'block';
          } else {
            suggestionBox.style.display = 'none';
            suggestionBox.innerHTML = '';
          }
        });
    });

    // When a suggestion is clicked, fill the update fields
    document.getElementById('updateStockSuggestion').addEventListener('click', function(e) {
      if(e.target && e.target.matches('button')) {
        const prodId = e.target.getAttribute('data-id');
        const prodName = e.target.getAttribute('data-name');
        const prodStock = e.target.getAttribute('data-stock');
        document.getElementById('updateProdId').value = prodId;
        document.getElementById('selectedProdName').value = prodName;
        document.getElementById('selectedProdStock').value = prodStock;
        // Hide suggestions and set search field to selected product name
        this.style.display = 'none';
        document.getElementById('updateStockSearch').value = prodName;
      }
    });

    /***********************
     Update Stock Form Submission
    ***********************/
    document.getElementById('updateStockForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const prodId = document.getElementById('updateProdId').value;
      const newStock = parseInt(document.getElementById('newProdStock').value);
      if(!prodId) {
        showToast("দয়া করে একটি পণ্য নির্বাচন করুন।", 'warning');
        return;
      }
      db.collection('products').doc(prodId).update({ stock: newStock })
      .then(() => {
        showToast("স্টক সফলভাবে আপডেট হয়েছে!", 'success');
        const updateModal = bootstrap.Modal.getInstance(document.getElementById('updateStockModal'));
        updateModal.hide();
      })
      .catch(error => {
        console.error("Error updating stock:", error);
        showToast("স্টক আপডেট করতে সমস্যা হয়েছে!", 'error');
      });
    });
  </script>
</body>
</html>
